---
x-ignition-common: &ignition-common
  image: &ignition-image inductiveautomation/ignition:8.3.3
  depends_on:
    db:
      condition: service_healthy
    bootstrap:
      condition: service_completed_successfully
  networks:
    proxy: {}

x-ignition-environment: &ignition-environment
  ACCEPT_IGNITION_EULA: "Y"
  IGNITION_EDITION: standard
  TZ: ${TZ}

services:
  bootstrap:
    image: *ignition-image
    entrypoint: ["/bin/bash", "/docker-bootstrap.sh"]
    volumes:
      - ./scripts/docker-bootstrap.sh:/docker-bootstrap.sh
      # Ignition data volumes to be seeded
      - ignition-blue-data:/seed/ignition-blue
      - ignition-red-data:/seed/ignition-red

  ignition-blue:
    <<: [*ignition-common]
    container_name: ignition-blue
    hostname: ignition-blue
    volumes:
      - ignition-blue-data:/usr/local/bin/ignition/data
      - ./services/ignition-blue/projects:/usr/local/bin/ignition/data/projects
      - ./services/ignition-blue/config/resources/core:/usr/local/bin/ignition/data/config/resources/core
      - ./services/ignition-blue/config/resources/dev:/usr/local/bin/ignition/data/config/resources/dev
      - ./shared/files/factory.json:/usr/local/bin/ignition/data/config/factory.json
      - ./shared/config/resources/external:/usr/local/bin/ignition/data/config/resources/external
    environment:
      <<: *ignition-environment
    labels:
      - traefik.hostname=ignition-blue
      - traefik.enable=true
    command: >
      -n ignition-blue
      -m 4096
      -h 80
      -s 443
      -a ignition-blue.localtest.me
      --
      gateway.useProxyForwardedHeader=true
      -Dignition.config.mode=${DEPLOYMENT_MODE:-dev}

  ignition-red:
    <<: [*ignition-common]
    container_name: ignition-red
    hostname: ignition-red
    volumes:
      - ignition-red-data:/usr/local/bin/ignition/data
      - ./services/ignition-red/projects:/usr/local/bin/ignition/data/projects
      - ./services/ignition-red/config/resources/core:/usr/local/bin/ignition/data/config/resources/core
      - ./services/ignition-red/config/resources/dev:/usr/local/bin/ignition/data/config/resources/dev
      - ./shared/files/factory.json:/usr/local/bin/ignition/data/factory.json
      - ./shared/config/resources/external:/usr/local/bin/ignition/data/config/resources/external
    environment:
      <<: *ignition-environment
    labels:
      - traefik.hostname=ignition-red
      - traefik.enable=true
    command: >
      -n ignition-red
      -m 4096
      -h 80
      -s 443
      -a ignition-red.localtest.me
      --
      gateway.useProxyForwardedHeader=true
      -Dignition.config.mode=${DEPLOYMENT_MODE:-dev}

  db:
    image: postgres:18.1
    hostname: db
    container_name: db
    volumes:
      - ./services/db/init:/docker-entrypoint-initdb.d
    environment:
      TZ: ${TZ}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-U", "ignition"]
      interval: 10s
      timeout: 20s
      retries: 10
    networks:
      proxy:
        aliases:
          - db

volumes:
  ignition-blue-data:
  ignition-red-data:

networks:
  proxy:
    external: true
